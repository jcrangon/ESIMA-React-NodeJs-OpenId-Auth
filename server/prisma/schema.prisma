// ------------------------------------------------------------------
// prisma/schema.prisma
// ------------------------------------------------------------------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ✅ Enum des rôles utilisateurs
enum UserRole {
  ROLE_USER
  ROLE_ADMIN
}

model User {
  id                 Int                  @id @default(autoincrement())
  email              String               @unique
  name               String?
  password           String

  /// ✅ Champ enum avec valeur par défaut
  role               UserRole             @default(ROLE_USER)

  /** Permet d’invalider toutes les sessions si le mot de passe change */
  passwordChangedAt  DateTime?

  refreshTokens      RefreshToken[]
  passwordResets     PasswordResetToken[]
  posts              Post[]

  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
}

model Post {
  id          Int      @id @default(autoincrement())
  title       String
  content     String
  coverUrl    String?
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([authorId])
}

model RefreshToken {
  id              Int       @id @default(autoincrement())
  token           String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          Int

  rememberMe      Boolean   @default(false)
  userAgent       String?
  ip              String?
  lastUsedAt      DateTime?
  replacedByToken String?
  revoked         Boolean   @default(false)

  createdAt       DateTime  @default(now())
  expiresAt       DateTime

  @@index([userId, revoked, expiresAt])
  @@index([expiresAt])
}

model PasswordResetToken {
  id         Int       @id @default(autoincrement())
  token      String    @unique
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int

  usedAt     DateTime?
  expiresAt  DateTime

  createdAt  DateTime  @default(now())

  @@index([userId, expiresAt])
  @@index([expiresAt])
}